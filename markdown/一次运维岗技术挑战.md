# Linux系统配置

## 安装Centos

### 下载镜像文件

![image-20191024220057957](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/image-20191024220057957.png)

### 通过VirtualBox 挂载镜像安装

![image-20191024223722733](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/image-20191024223722733.png)

![image-20191024220032047](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/image-20191024220032047.png)

### 导入到阿里云

1. 进行必要配置： 关闭Selinux ，关闭防火墙
2. 关机，上传VHD镜像到阿里云oss
![image-20191024225951591](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/image-20191024225951591.png)

3. 创建ECS并选择镜像
4. 从ECS开机
![1571932115788](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571932115788.png)

## 用户配置

### 添加用户

![image-20191024220416842](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/image-20191024220416842.png)

### 禁止用户使用sudo

默认刚添加的用户没在`/etc/sudoers`中，所以该用户没有sudo权限

![image-20191024221936406](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/image-20191024221936406.png)

### 关闭root用户密码登录

 把文件**/etc/ssh/sshd_config**文件中**PasswordAuthentication yes** 修改成 **PasswordAuthentication no** 

![1571932405973](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571932405973.png)

### 修改端口

![image-20191024221310226](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/image-20191024221310226.png)

### 重启sshd

![image-20191024221420037](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/image-20191024221420037.png)

## web服务器

### 编译安装nginx

```sh
wget http://nginx.org/download/nginx-1.17.5.tar.gz
tar -xvzf nginx-1.17.5.tar.gz
cd nginx-1.17.5
yum update
yum -y install gcc pcre pcre-devel zlib zlib-devel openssl openssl-devel

groupadd www
useradd -g www www

./configure \
--user=www \
--group=www \
--prefix=/usr/local/nginx \
--with-http_ssl_module \
--with-http_stub_status_module \
--with-http_realip_module \
--with-threads
make
make install

# 创建软连接
ln -s /usr/local/nginx/sbin/nginx /usr/bin/nginx
```

![image-20191024231648396](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/image-20191024231648396.png)

### 配置端口和证书

1. 申请证书
```sh
wget https://dl.eff.org/certbot-auto
chmod +x ./certbot-auto
./certbot-auto --nginx
```

2. 配置配置文件

![1571934307789](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571934307789.png)

3. 写入内容到index.html并开启nginx

![1571933426984](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571933426984.png)

### 完成

![1571934367248](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571934367248.png)

## 挂载硬盘

由于阿里云挂载硬盘最小限制20G，所以这里挂载的两个硬盘容量都是20G

![1571967799778](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571967799778.png)

### 安装mdadm

```sh
 yum install mdadm -y
```

![1571967594602](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571967594602.png)

### 配置raid

1. 格式化分区
![1571967986835](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571967986835.png)

2. 创建raid分区
![1571968064038](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571968064038.png)

对vdc也做同样的事情

![1571968188191](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571968188191.png)

3. 创建md设备

![1571968382964](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571968382964.png)

3. 查看结果

![1571968360263](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571968360263.png)

### 格式化并挂载raid分区

![1571968479204](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571968479204.png)

## GFW

### dnsmasq

1. 安装
```sh
yum install dnsmasq
```

2. 修改配置文件
```sh
vi /etc/dnsmasq.conf
```
![1571970400857](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571970400857.png)

3. 开启服务
![1571970601730](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571970601730.png)

### v2ray

1. 安装

   ```sh
   wget https://install.direct/go.sh
   sh go.sh
   ```

2. 配置

   `vi /etc/v2ray/config.json `修改outbound

   ```json
   "outbound": {
       "protocol": "vmess",
       "settings": {
         "vnext": [
           {
             "address": "gl.xiaoxx.cc",
             "port": 443,
             "users": [
               {
                 "id": "d147e9d0-1535-406f-b3ae-5abbfd9c3f8e",
                 "alterId": 64,
                 "security": "auto",
                 "level": 0
               }
             ]
           }
         ]
       },
   ```

3. 重启v2ray

   ![1571971105562](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571971105562.png)

4. 测试

   ![1571971181546](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571971181546.png)

### 转发

1. 配置ipset

   ```sh
   cd /etc/dnsmasq.d
   wget https://cokebar.github.io/gfwlist2dnsmasq/dnsmasq_gfwlist_ipset.conf
   ipset -N gfwlist hash:net maxelem 65536
   ```

2. iptables转发流量

   ```sh
   sudo iptables -t nat -A PREROUTING -p tcp -m set --match-set gfwlist dst -j REDIRECT --to-port 1080
   sudo iptables -t nat -A OUTPUT -p tcp -m set --match-set gfwlist dst -j REDIRECT --to-port 1080
   ```

3. 打开转发

   /etc/sysctl.conf 最后一行添加

   ```sh
   net.ipv4.ip_forward=1
   ```

4. 让更新生效

   ```sh
   sysctl -p
   ```

   ![1571971476523](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571971476523.png)

# 运维系统的构建 

## Jumpserver

### Nginx服务器

```sh
yum upgrade -y

# 获取 epel-release 源
yum -y install epel-release

# 设置 selinux
setenforce 0
sed -i "s/SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config
# 安装 Tengine

# 下载 luna
cd /opt
wget https://demo.jumpserver.org/download/luna/1.5.4/luna.tar.gz
tar xf luna.tar.gz
chown -R root:root luna
# 配置 Nginx
$ vi /etc/nginx/nginx.conf
load_module '/usr/lib64/nginx/modules/ngx_stream_module.so';
user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}

stream {
    log_format  proxy  '$remote_addr [$time_local] '
                       '$protocol $status $bytes_sent $bytes_received '
                       '$session_time "$upstream_addr" '
                       '"$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time"';

    access_log /var/log/nginx/tcp-access.log  proxy;
    open_log_file_cache off;

    upstream MariaDB {
        server 47.111.172.170:3306;
    }

    upstream kokossh {
        server 114.55.168.62:2222;
        server 114.55.168.62:2223;  # 多节点
        # 这里是 koko ssh 的后端ip
        least_conn;
    }

    server {
        listen 3306;
        proxy_pass MariaDB;
        proxy_connect_timeout 1s;  # detect failure quickly
    }

    server {
        listen 2222;
        proxy_pass kokossh;
        proxy_connect_timeout 1s;  # detect failure quickly
    }
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    # tcp_nopush     on;

    keepalive_timeout  65;

    # 关闭版本显示
    server_tokens off;

    include /etc/nginx/conf.d/*.conf;
}
# 备份默认的配置文件
$ mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.bak

$ vi /etc/nginx/conf.d/jumpserver.conf

upstream jumpserver {
    server 121.43.159.228:8080;
    # 这里是 jumpserver 的后端ip
}

upstream jumpserver_ws {
    server 121.43.159.228:8070;
    # 这里是 jumpserver 的后端ip
}

upstream koko {
    server 114.55.168.62:5000 weight=1;
    server 114.55.168.62:5001 weight=1;  # 多节点
    # 这里是 koko 的后端ip
    ip_hash;
}

upstream guacamole {
    server 114.55.168.62:8081 weight=1;
    server 114.55.168.62:8082 weight=1;  # 多节点
    # 这里是 guacamole 的后端ip
    ip_hash;
}

server {
    listen 80;
    server_name jump.xiaoxx.cc;  # 自行修改成你的域名
    
    client_max_body_size 100m;  # 录像上传大小限制

    location / {
        proxy_pass http://jumpserver;  # jumpserver
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        access_log off;
    }

    location /luna/ {
        try_files $uri / /index.html;
        alias /opt/luna/;  # luna 路径, 如果修改安装目录, 此处需要修改
    }

    location /koko/ {
        proxy_pass       http://koko;  # koko
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        access_log off;
    }

    location /ws/ {
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://jumpserver_ws;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /guacamole/ {
        proxy_pass       http://guacamole/;  #  guacamole
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $http_connection;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        access_log off;
    }
}


# nginx 测试并启动
$ nginx -t
```

![1571980591991](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571980591991.png)

### 数据库服务器配置

```sh
yum upgrade -y

# 添加 MariaDB 源
vi /etc/yum.repos.d/MariaDB.repo
[mariadb]
name = MariaDB
baseurl = http://mirrors.ustc.edu.cn/mariadb/yum/10.1/centos7-amd64
gpgkey=http://mirrors.ustc.edu.cn/mariadb/yum/RPM-GPG-KEY-MariaDB
gpgcheck=1

# 安装 MariaDB Galera Cluster
yum install -y mariadb mariadb-server MariaDB-shared mariadb-common galera rsync

setenforce 0
sed -i "s/SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config
# 在 47.111.172.170 上执行初始化命令
systemctl start mariadb
mysql_secure_installation  # 设置 root 密码, 其他选项全部 y
systemctl stop mariadb

$ vi /etc/my.cnf.d/server.cnf
...
[galera]
wsrep_on=ON
wsrep_provider=/usr/lib64/galera/libgalera_smm.so
wsrep_node_name=mariadb   # 注意这里改成本机 hostname
wsrep_node_address=47.111.172.170   # 注意这里改成本机 ip
binlog_format=row
default_storage_engine=InnoDB
innodb_autoinc_lock_mode=2
...


# 创建 Jumpserver 数据库及授权
$ mysql -uroot -p
> create database jumpserver default charset 'utf8';
> grant all on jumpserver.* to 'jumpserver'@'%' identified by '654321';
> flush privileges;
> quit
```

![1571980611849](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571980611849.png)

### jumpserver服务器配置

```sh
# 升级系统
yum upgrade -y

# 安装依赖包
yum -y install gcc epel-release git

# 安装 Python3.6
yum -y install python36 python36-devel

# 配置 py3 虚拟环境
python3.6 -m venv /opt/py3
source /opt/py3/bin/activate

# 下载 Jumpserver
git clone --depth=1 https://github.com/jumpserver/jumpserver.git

# 安装依赖 RPM 包
yum -y install $(cat jumpserver/requirements/rpm_requirements.txt)

# 安装 Python 库依赖
pip install --upgrade pip setuptools
pip install -r jumpserver/requirements/requirements.txt

# 修改 jumpserver 配置文件
cd jumpserver
cp config_example.yml config.yml

SECRET_KEY=`cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 50`  # 生成随机SECRET_KEY
echo "SECRET_KEY=$SECRET_KEY" >> ~/.bashrc
BOOTSTRAP_TOKEN=`cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 16`  # 生成随机BOOTSTRAP_TOKEN
echo "BOOTSTRAP_TOKEN=$BOOTSTRAP_TOKEN" >> ~/.bashrc

sed -i "s/SECRET_KEY:/SECRET_KEY: $SECRET_KEY/g" jumpserver/config.yml
sed -i "s/BOOTSTRAP_TOKEN:/BOOTSTRAP_TOKEN: $BOOTSTRAP_TOKEN/g" jumpserver/config.yml
sed -i "s/# DEBUG: true/DEBUG: false/g" jumpserver/config.yml
sed -i "s/# LOG_LEVEL: DEBUG/LOG_LEVEL: ERROR/g" jumpserver/config.yml
sed -i "s/# SESSION_EXPIRE_AT_BROWSER_CLOSE: false/SESSION_EXPIRE_AT_BROWSER_CLOSE: true/g" jumpserver/config.yml

echo -e "\033[31m 你的SECRET_KEY是 $SECRET_KEY \033[0m"
echo -e "\033[31m 你的BOOTSTRAP_TOKEN是 $BOOTSTRAP_TOKEN \033[0m"
```

![1571982508457](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571982508457.png)

```sh
$ vi config.yml
# SECURITY WARNING: keep the secret key used in production secret!
# 加密秘钥 生产环境中请修改为随机字符串, 请勿外泄, 升级或者迁移请保持不变
SECRET_KEY: UOizx8LprAUUy6rJ31qHArcCPGxGUSUgmD5EEsk8gpjdu02kQT

# SECURITY WARNING: keep the bootstrap token used in production secret!
# 预共享Token koko和guacamole用来注册服务账号, 不在使用原来的注册接受机制
BOOTSTRAP_TOKEN: 0sW8us2otDIRCqmq

# Development env open this, when error occur display the full process track, Production disable it
# DEBUG 模式 开启DEBUG后遇到错误时可以看到更多日志
DEBUG: true

# DEBUG, INFO, WARNING, ERROR, CRITICAL can set. See https://docs.djangoproject.com/en/1.10/topics/logging/
# 日志级别
LOG_LEVEL: ERROR
# LOG_DIR:

# Session expiration setting, Default 24 hour, Also set expired on on browser close
# 浏览器Session过期时间, 默认24小时, 也可以设置浏览器关闭则过期
# SESSION_COOKIE_AGE: 86400
SESSION_EXPIRE_AT_BROWSER_CLOSE: true

# Database setting, Support sqlite3, mysql, postgres ....
# 数据库设置
# See https://docs.djangoproject.com/en/1.10/ref/settings/#databases

# SQLite setting:
# 使用单文件sqlite数据库
# DB_ENGINE: sqlite3
# DB_NAME:

# MySQL or postgres setting like:
# 使用Mysql作为数据库
DB_ENGINE: mysql
DB_HOST: "47.111.172.170"
DB_PORT: 3306
DB_USER: "jumpserver"
DB_PASSWORD: "654321"
DB_NAME: "jumpserver"

# When Django start it will bind this host and port
# ./manage.py runserver 127.0.0.1:8080
# 运行时绑定端口
HTTP_BIND_HOST: 0.0.0.0
HTTP_LISTEN_PORT: 8080

# Use Redis as broker for celery and web socket
# Redis配置
REDIS_HOST: 127.0.0.1
REDIS_PORT: 6379
# REDIS_PASSWORD:
# REDIS_DB_CELERY: 3
# REDIS_DB_CACHE: 4

# Use OpenID authorization
# 使用OpenID 来进行认证设置
# BASE_SITE_URL: http://localhost:8080
# AUTH_OPENID: false  # True or False
# AUTH_OPENID_SERVER_URL: https://openid-auth-server.com/
# AUTH_OPENID_REALM_NAME: realm-name
# AUTH_OPENID_CLIENT_ID: client-id
# AUTH_OPENID_CLIENT_SECRET: client-secret

# OTP settings
# OTP/MFA 配置
# OTP_VALID_WINDOW: 0
# OTP_ISSUER_NAME: Jumpserver

# 运行 Jumpserver

./jms start  # 后台运行使用 -d 参数./jms start -d
# 新版本更新了运行脚本, 使用方式./jms start|stop|status all  后台运行请添加 -d 参数

# 需要把 jumpserver/data/ 目录同步给其他 jumpserver 服务器 和 Tengine 服务器使用, 建议使用共享文件夹或者 oss 解决
# 多节点部署, 请参考此文档, 设置数据库时请选择从库, 其他的一样
```

![1571986371824](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571986371824.png)

### koko&guacamole

```sh
# 升级系统
$ yum upgrade -y

# 安装 docker
yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum makecache fast
yum -y install docker-ce
curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://f1361db2.m.daocloud.io
systemctl enable docker
systemctl start docker

# 通过 docker 部署 koko
docker run --name jms_koko -d \
    -p 2222:2222 \
    -p 5000:5000 \
    -e CORE_HOST=http://121.43.159.228:8080 \
    -e BOOTSTRAP_TOKEN=0sW8us2otDIRCqmq \
    jumpserver/jms_koko:1.5.4

# 通过 docker 部署 guacamole
docker run --name jms_guacamole -d \
    -p 8081:8080 \
    -e JUMPSERVER_KEY_DIR=/config/guacamole/key \
    -e JUMPSERVER_SERVER=http://121.43.159.228:8080 \
    -e BOOTSTRAP_TOKEN=0sW8us2otDIRCqmq \
    jumpserver/jms_guacamole:1.5.4

# 访问 http://118.31.227.159/terminal/terminal/ 检查 koko 注册
```

![1571982243898](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571982243898.png)

### 总结

![1571988741638](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571988741638.png)

- 系统: CentOS 7
- 数据库 IP: 47.111.172.170
- Jumpserver&redis IP: 121.43.159.228
- koko&Guacamole IP: 114.55.168.62
- Nginx IP: 118.31.227.159

| Protocol | Server name | Port       | Used By                |
| -------- | ----------- | ---------- | ---------------------- |
| TCP      | Jumpserver  | 8070, 8080 | Nginx, koko, Guacamole |
| TCP      | koko        | 2222, 5000 | Tengine                |
| TCP      | Guacamole   | 8081       | Tengine                |
| TCP      | Db          | 3306       | Jumpserver             |
| TCP      | Redis       | 6379       | Jumpserver             |
| TCP      | Tengine     | 80, 2222   | All User               |

## 监控

### zabbix Agent

- 安装

  ```sh
  rpm -Uvh https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-2.el7.noarch.rpm
  yum install zabbix-agent -y
  ```

- 配置

  $ sudo vi /etc/zabbix/zabbix_agentd.conf

  ```
  Server=47.97.72.31 #zabbix-server端IP
  
  ServerActive=47.97.72.31 #zabbix-server端IP
  
  Hostname=Koko-Guacamole
  ```

- 重启

  ```sh
  systemctl restart zabbix-agent
  ```

### zabbix Server

使用阿里云公共镜像

![1571990422617](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571990422617.png)

- 启动

  ![1571990560392](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571990560392.png)

- 添加主机

  ![1571994613480](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571994613480.png)

- 选择模板

  ![1571994634100](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571994634100.png)
  
- 添加完成

  ![1572000465987](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1572000465987.png)

- 查看监测信息

  ![1572000591123](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1572000591123.png)

  ![1572000619488](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1572000619488.png)
  
  ![1572000959751](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1572000959751.png)

### Grafana

- 安装

```sh
wget https://dl.grafana.com/oss/release/grafana-6.4.3-1.x86_64.rpm
sudo yum localinstall grafana-6.4.3-1.x86_64.rpm
```

```sh
#安装zabbix插件
grafana-cli plugins install alexanderzobnin-zabbix-app

#安装插件完成之后重启garfana服务
service grafana-server restart
#使用grafana-zabbix-app源，其中包含最新版本的插件

cd /var/lib/grafana/plugins/
#克隆grafana-zabbix-app插件项目

git clone https://github.com/alexanderzobnin/grafana-zabbix-app

service grafana-server restart
#注：通过这种方式，可以很容器升级插件

cd /var/lib/grafana/plugins/grafana-zabbix-app
git pull
service grafana-server restart
```

- 访问

   http://47.97.72.31:3000 

  ![1571992790275](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1571992790275.png)
  
- 创建Dashboard

   ![1572002714522](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1572002714522.png)

- 添加图表

   ![1572002791212](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1572002791212.png)

- 面板显示各主机CPU和内存情况

   ![1572003091271](https://xiaoxx.oss-cn-beijing.aliyuncs.com/md-img/1572003091271.png)

# 总结

Zabbix服务器： http://47.97.72.31/zabbix 

> 账号: Admin			密码: zabbix 
>
> mysql 账号: root     mysql 密码: Yuncan123 

Grafana地址：http://47.97.72.31:3000 

> 账号: admin			密码: admin

Jumpserver：http://jump.xiaoxx.cc

> 账号: admin			密码: admin